variables:
  WORK_DIR: ${SDK_WORK_DIR}/pip
  REQUIREMENTS: .gitlab/venv-requirements.txt
  RADICAL_PILOT_DBURL: ${MONGODB_CONNECTION_STRING}?tlsAllowInvalidCertificates=true
  TEST_TYPE: "pip"

stages:
  - setup
  - build
  - test
  - cleanup

.final_steps:
  script: &finalize
    - chgrp -fR exaworks ${WORK_DIR} || true
    - chmod -fR 02770 ${WORK_DIR}    || true

pip-env-setup:
  stage: setup
  parallel:
    matrix:
      - HOST : [ "quartz" ]
        VENV_ENV_NAME: [ "quartz-env" ]
        RUNNER_TYPE: "shell"
      - HOST : [ "ruby" ]
        VENV_ENV_NAME: [ "ruby-env" ]
        RUNNER_TYPE: "shell"
      # - HOST : [ "lassen" ]
      #   ENVIRONMENT: [ "BATCH" ]
      #   VENV_ENV_NAME: [ "lassen-env" ]
      #   RUNNER_TYPE: "batch"
  tags:
    - $HOST
    - $RUNNER_TYPE
  script:
    - test -d ${WORK_DIR}/${VENV_ENV_NAME} && exit 0
    - mkdir -p ${WORK_DIR}
    - python3 -m venv ${WORK_DIR}/${VENV_ENV_NAME}
    - source ${WORK_DIR}/${VENV_ENV_NAME}/bin/activate
    - pip install -U pip setuptools wheel
    - pip cache purge

pip-build:
  stage: build
  needs:
    - job: pip-env-setup
  parallel:
    matrix:
      - HOST : [ "quartz" ]
        VENV_ENV_NAME: [ "quartz-env" ]
        RUNNER_TYPE: "shell"
      - HOST : [ "ruby" ]
        VENV_ENV_NAME: [ "ruby-env" ]
        RUNNER_TYPE: "shell"
      # - HOST : [ "lassen" ]
      #   ENVIRONMENT: [ "BATCH" ]
      #   VENV_ENV_NAME: [ "lassen-env" ]
      #   RUNNER_TYPE: "batch"
  tags:
    - $HOST
    - $RUNNER_TYPE
  script:
    - source ${WORK_DIR}/${VENV_ENV_NAME}/bin/activate
    - pip install --no-cache-dir -r ${REQUIREMENTS}
    - *finalize

pip-tests:
  stage: test
  needs: 
    - job: pip-build
  parallel:
    matrix:
      - HOST : [ "quartz" ]
        VENV_ENV_NAME: [ "quartz-env" ]
        RUNNER_TYPE: "batch"
      - HOST : [ "ruby" ]
        VENV_ENV_NAME: [ "ruby-env" ]
        RUNNER_TYPE: "batch"
      # - HOST : [ "lassen" ]
      #   ENVIRONMENT: [ "BATCH" ]
      #   VENV_ENV_NAME: [ "lassen-env" ]
      #   RUNNER_TYPE: "batch"
  tags:
    - $HOST
    - $RUNNER_TYPE
  script:
    - source ${WORK_DIR}/${VENV_ENV_NAME}/bin/activate
    - export run_id=${CI_PIPELINE_ID}
    - export branch=${CI_COMMIT_BRANCH}
    - export url=${TESTING_HOST}
    - export test=${TEST_TYPE}
    - export location="llnl-$HOST"
    - export contact="arambula2@llnl.gov"
    - export imnumber="LLNL-MI-834241"
    - python3 ci/tests/test.py -s
    - for TEST in flux parsl rp swift-t parsl-flux rp-flux; do
        python3 ci/tests/test.py -n $TEST -c "bash ci/tests/${TEST}/test.sh";
      done
    - python3 ci/tests/test.py -e
    - deactivate

.pip-env-cleanup: &pip-env-cleanup
  stage: cleanup
  tags:
    - quartz
    - shell
  script:
    - cd ${SDK_WORK_DIR}
    - pip cache purge
    - *finalize

pip-cleanup-on-build-failure:
  needs:
    - job: pip-build
  when: on_failure
  <<: *pip-env-cleanup

pip-cleanup-on-test-failure:
  needs:
    - job: pip-tests
  when: on_failure
  <<: *pip-env-cleanup

pip-cleanup-on-success:
  needs:
    - job: pip-tests
  when: on_success
  <<: *pip-env-cleanup
