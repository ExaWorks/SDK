stages:
  - update
  - build
  - test

Spack Update:
  stage: update
  tags:
    - quartz
    - shell
  needs: []
  script:
    - cd $SPACK_WORK_DIR/spack/
    - git pull --ff


Spack Build:
  stage: build
  parallel:
    matrix:
      - HOST : ["quartz"]
        SPACK_ENV_NAME : ["rhel7-broadwell"]
        COMPILER : ["gcc@8.1.0"]
      - HOST : ["lassen"]
        SPACK_ENV_NAME : ["rhel7-ppc64le"]
        COMPILER : ["gcc@9.4.0"]
      - HOST : ["ruby"]
        SPACK_ENV_NAME : ["rhel7-cascadelake"]
        COMPILER : ["gcc@8.2.0"]
  tags:
    - $HOST
    - shell
  needs: [Spack Update]
  script:
    - . $SPACK_WORK_DIR/spack/share/spack/setup-env.sh
    - spack env activate $SPACK_ENV_NAME
    - spack uninstall -y exaworks%$COMPILER py-pytest || true
    - spack install --fresh exaworks%$COMPILER py-pytest

Spack Test:
  variables:
    LLNL_SLURM_SCHEDULER_PARAMETERS: "--nodes=1 -t 15"
  stage: test
  before_script:
    - whoami
  parallel:
    matrix:
      - HOST : ["quartz"]
        SPACK_ENV_NAME : ["rhel7-broadwell"]
        COMPILER : ["gcc@8.1.0"]
      - HOST : ["lassen"]
        SPACK_ENV_NAME : ["rhel7-ppc64le"]
        COMPILER : ["gcc@9.4.0"]
      - HOST : ["ruby"]
        SPACK_ENV_NAME : ["rhel7-cascadelake"]
        COMPILER : ["gcc@8.2.0"]
  tags:
    - batch
    - $HOST
  needs: [Spack Build]
  script:
    - . $SPACK_WORK_DIR/spack/share/spack/setup-env.sh
    - spack env activate $SPACK_ENV_NAME
    - spack load exaworks%$COMPILER py-pytest
    - export RADICAL_PILOT_DBURL=${MONGODB_CONNECTION_STRING}?tlsAllowInvalidCertificates=true
    - export run_id=$RANDOM
    - export branch=$CI_COMMIT_BRANCH
    - export url=$TESTING_HOST
    - export test="Spack"
    - export location="llnl-$HOST"
    - export contact="morton30@llnl.gov"
    - export imnumber="LLNL-MI-834241"
    - python3 ci/tests/test.py -s
    - >
        for TEST in flux parsl rp swift-t parsl-flux; do
        python3 ci/tests/test.py -n $TEST -c
        "bash ci/tests/${TEST}/test.sh";
        done;
    - python3 ci/tests/test.py -e
  after_script:
    - whoami
