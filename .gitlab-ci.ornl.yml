
stages:
  - build
  - test
  - clean

Spack Build:
  stage: build
  tags:
    - nobatch
  needs: []
  variables:
    CUSTOM_CI_BUILDS_DIR: "/gpfs/wolf/proj-shared/csc449/ci/${CI_PIPELINE_ID}"
    WORK: "/gpfs/wolf/proj-shared/csc449/ci/${CI_PIPELINE_ID}"
  script:
    - mkdir -p $WORK
    - cd $WORK
    - git clone -c feature.manyFiles=true https://github.com/spack/spack.git spack
    - . $WORK/spack/share/spack/setup-env.sh
    - spack install exaworks
    - spack install py-pytest


Spack Test:
  stage: test
  parallel:
      matrix:
        - TEST : ["rp", "swift-t", "parsl", "flux", "rp-flux", "parsl-flux"]
  before_script:
    - whoami
  tags:
    - batch
  needs: [Spack Build]
  variables:
    SCHEDULER_PARAMETERS: "-P CSC449 -nnodes 1 -W 30"
    CUSTOM_CI_BUILDS_DIR: "/gpfs/wolf/proj-shared/csc449/ci/${CI_PIPELINE_ID}"
    WORK: "/gpfs/wolf/proj-shared/csc449/ci/${CI_PIPELINE_ID}"
  script:
    - cd $WORK
    - . $WORK/spack/share/spack/setup-env.sh
    - spack load exaworks py-pytest
    - ls -la 
    - du -a ci
    - bash ci/tests/${TEST}/test.sh
  after_script:
    - whoami


Spack Clean:
  stage: clean
  before_script:
    - whoami
  tags:
    - nobatch
  needs: [Spack Test]
  variables:
    CUSTOM_CI_BUILDS_DIR: "/gpfs/wolf/proj-shared/csc449/ci/${CI_PIPELINE_ID}"
    WORK: "/gpfs/wolf/proj-shared/csc449/ci/${CI_PIPELINE_ID}"
  script:
    - rm -rf $WORK/spack/

